{% extends '_layout' %}

{% do craft.app.view.registerCssFile('https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/css/glide.core.min.css') %}
{% do craft.app.view.registerJsFile('https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/glide.min.js') %}

{% block content %}
  {% set photos = craft.entries()
    .section(entry.title)
    .status('live')
    .orderBy('postDate desc')
    .all()
  %}

  <section aria-labelledby="gallery-title" class="gallery-page">
    <div>
      <div class="gallery-shell mx-auto flex max-w-6xl flex-col gap-6 bg-slate-100 px-4 py-6 sm:px-8 sm:py-8">

        <div class="block md:hidden">
          <div class="flex flex-col items-center gap-4">
            <h1 class="text-[clamp(2.5rem,9vw,5rem)] text-brand font-extrabold lowercase tracking-tight">{{entry.title}}</h1>
          </div>
        </div>
        
        {% if photos|length %}
          <div class="glide gallery-glide" role="region" aria-label="{{ entry.title }} image carousel" tabindex="0">
            <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-700">
              <div class="flex items-center gap-2">
                <span class="sr-only" id="carousel-status" aria-live="polite"></span>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between text-md font-semibold uppercase tracking-wide text-slate-700" data-glide-el="controls">
              <button class="px-3 py-2 font-extrabold hover:text-brand focus-visible:outline-none focus-visible:ring focus-visible:ring-brand/50" data-glide-dir="<" aria-label="Previous slide">[PREV]</button>
              <button class="px-3 py-2 font-extrabold hover:text-brand focus-visible:outline-none focus-visible:ring focus-visible:ring-brand/50" data-glide-dir=">" aria-label="Next slide">[NEXT]</button>
            </div>

            <div class="glide__track mt-2" data-glide-el="track">
              <ul class="glide__slides">
                {% for photo in photos %}
                  {% set img = photo.image.one() %}
                  {% if img %}
                    {% set altText = img.alt ?? photo.title %}
                    {% set transformedUrl = img.getUrl('fit') ?? img.url %}
                    {% set transformedWidth = img.getWidth('fit') ?? img.width ?? null %}
                    {% set transformedHeight = img.getHeight('fit') ?? img.height ?? null %}

                    <li
                      class="glide__slide"
                      data-lightbox-index="{{ loop.index0 }}"
                      data-full-url="{{ img.url }}"
                      data-alt="{{ altText }}"
                    >
                      <p class="py-2 font-extrabold text-center "><span class="px-3 py-4 text-brand">{{photo.shootingSettings}}</p>
                      <div class="gallery-slide-frame relative mx-auto w-full max-w-md overflow-hidden border border-slate-300 bg-white shadow cursor-zoom-in">
                        <img
                          class="h-full w-full object-cover"
                          src="{{ transformedUrl }}"
                          alt="{{ altText }}"
                          loading="lazy"
                          width="{{ transformedWidth }}"
                          height="{{ transformedHeight }}"
                        >
                      </div>
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>

            <div class="glide__bullets mt-4 flex flex-wrap justify-center gap-2" data-glide-el="controls[nav]">
              {% for photo in photos %}
                {% set thumb = photo.image.one() %}
                {% if thumb %}
                  {% set thumbUrl = thumb.getUrl('fit') ?? thumb.url %}
                    <button
                      class="glide__bullet group overflow-hidden border border-slate-200 bg-white shadow-sm ring-offset-2 transition hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring focus-visible:ring-brand/50"
                      data-glide-dir="={{ loop.index0 }}"
                      aria-label="Go to slide {{ loop.index }}"
                    >
                      <img class="h-full w-full object-cover transition duration-150 ease-in-out group-[[data-glide-dir]].glide__bullet--active:opacity-100" src="{{ thumbUrl }}" alt="" aria-hidden="true">
                    </button>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

          <div class="hidden md:block">
            <div class="flex flex-col items-center gap-4">
              <h1 class="text-[clamp(2.5rem,9vw,5rem)] text-brand font-extrabold lowercase tracking-tight">{{entry.title}}</h1>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="gallery-lightbox" data-lightbox aria-hidden="true">
    <button class="lightbox-backdrop" type="button" data-lightbox-close aria-label="Close lightbox"></button>
    <div class="lightbox-dialog" role="dialog" aria-modal="true">
      <div class="lightbox-toolbar">
        <button class="lightbox-button" type="button" data-lightbox-prev aria-label="Previous image">[Prev]</button>
        <button class="lightbox-button" type="button" data-lightbox-close aria-label="Close lightbox">[Close]</button>
        <button class="lightbox-button" type="button" data-lightbox-next aria-label="Next image">[Next]</button>
      </div>
      <div class="lightbox-frame">
        <img data-lightbox-image alt="" loading="lazy">
      </div>
    </div>
  </div>

  {% js %}
    const carouselEl = document.querySelector('.gallery-glide');
    if (carouselEl) {
      const statusEl = document.getElementById('carousel-status');
      const countEl = document.getElementById('carousel-count');
      const bullets = Array.from(carouselEl.querySelectorAll('.glide__bullet'));
      const totalSlides = carouselEl.querySelectorAll('.glide__slide').length;
      let autoplayEnabled = false;

      const glide = new Glide(carouselEl, {
        type: 'carousel',
        focusAt: 'center',
        perView: 1,
        gap: 24,
        autoplay: false,
        hoverpause: true,
        animationDuration: 550,
        breakpoints: {
          1024: { gap: 16 },
          640: { gap: 12 }
        }
      });

      const updateStatus = (index) => {
        const humanIndex = index + 1;
        const message = `Slide ${humanIndex} of ${totalSlides}`;
        if (countEl) countEl.textContent = message;
        if (statusEl) statusEl.textContent = message;
        bullets.forEach((btn, i) => {
          const isCurrent = i === index;
          btn.classList.toggle('glide__bullet--active', isCurrent);
          btn.setAttribute('aria-current', isCurrent ? 'true' : 'false');
        });
      };

      glide.on(['mount.after', 'run.after'], () => {
        updateStatus(glide.index);
      });

      glide.mount();

      const lightbox = document.querySelector('[data-lightbox]');
      const lightboxImg = lightbox?.querySelector('[data-lightbox-image]');
      const lightboxPrev = lightbox?.querySelector('[data-lightbox-prev]');
      const lightboxNext = lightbox?.querySelector('[data-lightbox-next]');
      const lightboxCloseBtns = lightbox ? Array.from(lightbox.querySelectorAll('[data-lightbox-close]')) : [];
      let lightboxIndex = 0;

      const slides = Array.from(carouselEl.querySelectorAll('.glide__slide'));
      const slideData = slides.map((slide) => {
        const imgEl = slide.querySelector('img');
        const fullUrl = slide.dataset.fullUrl || imgEl?.src || '';
        const alt = slide.dataset.alt || imgEl?.alt || '';
        return { fullUrl, alt };
      });

      const openLightboxAt = (index) => {
        if (!lightbox || !lightboxImg || !slideData[index]) return;
        lightboxIndex = index;
        const data = slideData[index];
        lightboxImg.src = data.fullUrl;
        lightboxImg.alt = data.alt;
        lightbox.dataset.open = 'true';
        lightbox.removeAttribute('aria-hidden');
        lightbox.classList.add('is-open');
        document.body.classList.add('overflow-hidden');
        glide.go(`=${index}`);
      };

      const closeLightbox = () => {
        if (!lightbox) return;
        lightbox.dataset.open = 'false';
        lightbox.setAttribute('aria-hidden', 'true');
        lightbox.classList.remove('is-open');
        document.body.classList.remove('overflow-hidden');
      };

      slides.forEach((slide, idx) => {
        const frame = slide.querySelector('.gallery-slide-frame');
        if (frame) {
          frame.addEventListener('click', () => openLightboxAt(idx));
        }
      });

      lightboxPrev?.addEventListener('click', () => {
        const nextIdx = (lightboxIndex - 1 + slideData.length) % slideData.length;
        openLightboxAt(nextIdx);
      });

      lightboxNext?.addEventListener('click', () => {
        const nextIdx = (lightboxIndex + 1) % slideData.length;
        openLightboxAt(nextIdx);
      });

      lightboxCloseBtns.forEach((btn) => {
        btn.addEventListener('click', closeLightbox);
      });

      document.addEventListener('keydown', (event) => {
        if (!lightbox || lightbox.dataset.open !== 'true') return;
        if (event.key === 'Escape') {
          closeLightbox();
        } else if (event.key === 'ArrowLeft') {
          const nextIdx = (lightboxIndex - 1 + slideData.length) % slideData.length;
          openLightboxAt(nextIdx);
          event.preventDefault();
        } else if (event.key === 'ArrowRight') {
          const nextIdx = (lightboxIndex + 1) % slideData.length;
          openLightboxAt(nextIdx);
          event.preventDefault();
        }
      });

      carouselEl.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowLeft') {
          glide.go('<');
          event.preventDefault();
        } else if (event.key === 'ArrowRight') {
          glide.go('>');
          event.preventDefault();
        }
      });
    }
  {% endjs %}
{% endblock %}
